```html
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Калькулятор плитки "Новый город"</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <style>
        :root {
            --primary: #0984e3;
            --secondary: #6c5ce7;
            --success: #00b894;
            --danger: #d63031;
            --warning: #fdcb6e;
            --info: #74b9ff;
            --light: #f8f9fa;
            --dark: #2d3436;
            --gray: #636e72;
            --border: #ddd;
            --shadow: rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .tcalc-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .tcalc-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px var(--shadow);
        }

        .tcalc-header-content {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .tcalc-header-logo img {
            height: 54px;
            width: auto;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            background: #fff;
            filter: brightness(1.7) grayscale(0.2);
        }

        .tcalc-header-title h1 {
            margin-bottom: 6px;
            font-size: 1.8rem;
        }

        .tcalc-header-title p {
            margin: 0;
            opacity: 0.9;
            font-size: 16px;
        }

        .tcalc-content {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .tcalc-sidebar {
            flex: 1;
            min-width: 300px;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px var(--shadow);
            align-self: flex-start;
        }

        .tcalc-main {
            flex: 3;
            min-width: 300px;
        }

        .tcalc-section {
            margin-bottom: 25px;
        }

        .tcalc-section h3 {
            margin-bottom: 15px;
            color: var(--dark);
            font-size: 1.2rem;
            border-bottom: 2px solid var(--light);
            padding-bottom: 8px;
        }

        .tcalc-upload {
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #fafafa;
        }

        .tcalc-upload:hover {
            border-color: var(--primary);
            background: #f0f8ff;
        }

        .tcalc-upload-icon {
            margin-bottom: 10px;
            color: var(--gray);
        }

        .tcalc-upload-text {
            font-size: 14px;
            color: var(--gray);
        }

        .tcalc-tools {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .tcalc-tool-btn {
            flex: 1;
            min-width: 100px;
            padding: 10px;
            border: 1px solid var(--border);
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            font-size: 14px;
        }

        .tcalc-tool-btn:hover {
            background: #f0f8ff;
            border-color: var(--primary);
        }

        .tcalc-tool-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .tcalc-canvas-container {
            position: relative;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 10px var(--shadow);
            height: 600px;
        }

        #tcalc-canvas {
            width: 100%;
            height: 100%;
        }

        .tcalc-zoom-controls {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 5px;
            background: rgba(255, 255, 255, 0.9);
            padding: 5px;
            border-radius: 20px;
            box-shadow: 0 2px 8px var(--shadow);
        }

        .tcalc-zoom-btn {
            width: 30px;
            height: 30px;
            border: none;
            background: white;
            border-radius: 50%;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 3px var(--shadow);
        }

        .tcalc-zoom-btn:hover {
            background: var(--light);
        }

        .tcalc-zoom-level {
            padding: 0 10px;
            font-weight: bold;
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .tcalc-status {
            padding: 12px 15px;
            background: var(--light);
            border-radius: 8px;
            margin-top: 15px;
            font-size: 14px;
            color: var(--gray);
        }

        .tcalc-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .tcalc-btn {
            flex: 1;
            min-width: 120px;
            padding: 12px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            text-align: center;
        }

        .tcalc-btn-primary {
            background: var(--primary);
            color: white;
        }

        .tcalc-btn-primary:hover {
            background: #0770c4;
        }

        .tcalc-btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .tcalc-btn-secondary:hover {
            background: #5a4bd4;
        }

        .tcalc-btn-success {
            background: var(--success);
            color: white;
        }

        .tcalc-btn-success:hover {
            background: #009e7d;
        }

        .tcalc-btn-warning {
            background: var(--warning);
            color: var(--dark);
        }

        .tcalc-btn-warning:hover {
            background: #f9b64d;
        }

        .tcalc-stats {
            background: #e8f4ff;
            border-radius: 8px;
            padding: 15px;
        }

        .tcalc-stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .tcalc-stat-item:last-child {
            margin-bottom: 0;
        }

        .tcalc-stat-label {
            font-weight: 500;
        }

        .tcalc-stat-value {
            font-weight: 600;
            color: var(--primary);
        }

        .tcalc-tile-counts {
            display: grid;
            gap: 15px;
        }

        .tcalc-count-item {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px var(--shadow);
        }

        .tcalc-count-label {
            font-weight: 500;
        }

        .tcalc-count-value {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--success);
        }

        .tcalc-total {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px dashed var(--border);
            font-weight: 700;
            font-size: 1.1rem;
            text-align: right;
        }

        .tcalc-total span {
            color: var(--danger);
        }

        .tcalc-instructions ol {
            padding-left: 20px;
        }

        .tcalc-instructions li {
            margin-bottom: 10px;
        }

        #tcalc-size-menu {
            position: absolute;
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 12px var(--shadow);
            z-index: 1000;
            min-width: 250px;
        }

        .tcalc-size-menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }

        .tcalc-size-menu-title {
            font-weight: 600;
        }

        .tcalc-size-menu-close {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: var(--gray);
        }

        .tcalc-size-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .tcalc-input-group {
            display: flex;
            flex-direction: column;
        }

        .tcalc-input-group label {
            font-size: 12px;
            margin-bottom: 4px;
            color: var(--gray);
        }

        .tcalc-input-group input {
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 4px;
        }

        .tcalc-size-actions {
            display: flex;
            gap: 10px;
        }

        .tcalc-size-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .tcalc-size-btn-primary {
            background: var(--primary);
            color: white;
        }

        .tcalc-progress {
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }

        .tcalc-progress-fill {
            height: 100%;
            background: var(--success);
            width: 0%;
            transition: width 0.3s;
        }

        .tcalc-progress-text {
            text-align: center;
            font-size: 14px;
            margin-top: 5px;
            color: var(--gray);
        }

        @media (max-width: 768px) {
            .tcalc-content {
                flex-direction: column;
            }
            
            .tcalc-header-content {
                flex-direction: column;
                text-align: center;
            }
            
            .tcalc-tool-btn {
                min-width: 80px;
                font-size: 12px;
                padding: 8px;
            }
            
            .tcalc-btn {
                min-width: 100px;
                padding: 10px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="tcalc-container" id="tcalc-calculator">
        <div class="tcalc-header" id="tcalc-header">
            <div class="tcalc-header-content">
                <div class="tcalc-header-logo">
                    <img src="https://raw.githubusercontent.com/PashaDe/tcalc-js/main/logoplit.png" alt="Логотип" loading="lazy">
                </div>
                <div class="tcalc-header-title">
                    <h1>Калькулятор плитки "Новый город"</h1>
                    <p>Нарисуйте границы участка и заполните плиткой</p>
                </div>
                <div class="tcalc-header-spacer"></div>
            </div>
        </div>

        <div class="tcalc-content">
            <div class="tcalc-sidebar">
                <div class="tcalc-section">
                    <h3>Загрузка плана</h3>
                    <div class="tcalc-upload" onclick="document.getElementById('tcalc-plan-upload').click()">
                        <div class="tcalc-upload-icon">
                            <svg width="32" height="32" viewBox="0 0 32 32" style="transform: rotate(180deg);" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M26 22V26C26 27.0609 25.5786 28.0783 24.8284 28.8284C24.0783 29.5786 23.0609 30 22 30H10C8.93913 30 7.92172 29.5786 7.17157 28.8284C6.42143 28.0783 6 27.0609 6 26V22" stroke="#636e72" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M22 14L16 8L10 14" stroke="#636e72" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M16 8V22" stroke="#636e72" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <div class="tcalc-upload-text">Нажмите для загрузки плана</div>
                    </div>
                    <input type="file" id="tcalc-plan-upload" accept="image/*" style="display: none;" onchange="loadPlan(event)">
                </div>

                <div class="tcalc-section">
                    <h3>Инструменты</h3>
                    <div class="tcalc-tools">
                        <button class="tcalc-tool-btn active" data-tool="ruler" onclick="selectTool('ruler')">Прямоугольник</button>
                        <button class="tcalc-tool-btn" data-tool="polygon" onclick="selectTool('polygon')">Полигон</button>
                        <button class="tcalc-tool-btn" data-tool="eraser" onclick="selectTool('eraser')">Ластик</button>
                    </div>
                </div>

                <div class="tcalc-section">
                    <h3>Статистика</h3>
                    <div class="tcalc-stats">
                        <div class="tcalc-stat-item">
                            <span class="tcalc-stat-label">Площадь участка:</span>
                            <span class="tcalc-stat-value" id="tcalc-area">0 м²</span>
                        </div>
                        <div class="tcalc-stat-item">
                            <span class="tcalc-stat-label">Периметр:</span>
                            <span class="tcalc-stat-value" id="tcalc-perimeter">0 м</span>
                        </div>
                        <div class="tcalc-stat-item">
                            <span class="tcalc-stat-label">Покрытие:</span>
                            <span class="tcalc-stat-value" id="tcalc-coverage">0%</span>
                        </div>
                        <div class="tcalc-stat-item">
                            <span class="tcalc-stat-label">Общая стоимость:</span>
                            <span class="tcalc-stat-value" id="tcalc-cost">0 руб.</span>
                        </div>
                    </div>
                </div>

                <div class="tcalc-section">
                    <h3>Количество плиток</h3>
                    <div class="tcalc-tile-counts">
                        <div class="tcalc-count-item">
                            <span class="tcalc-count-label">Большая плитка (330×220):</span>
                            <span class="tcalc-count-value" id="tcalc-count-large">0</span>
                        </div>
                        <div class="tcalc-count-item">
                            <span class="tcalc-count-label">Средняя плитка (220×220):</span>
                            <span class="tcalc-count-value" id="tcalc-count-medium">0</span>
                        </div>
                        <div class="tcalc-count-item">
                            <span class="tcalc-count-label">Малая плитка (110×220):</span>
                            <span class="tcalc-count-value" id="tcalc-count-small">0</span>
                        </div>
                        <div class="tcalc-total">
                            Общее количество плиток: <span id="tcalc-total-count">0</span>
                        </div>
                    </div>
                </div>

                <div class="tcalc-section">
                    <h3>Управление</h3>
                    <div class="tcalc-controls">
                        <button class="tcalc-btn tcalc-btn-success" onclick="fillAreaWithTiles()">Заполнить участок плиткой</button>
                        <button class="tcalc-btn tcalc-btn-primary" onclick="clearTiles()">Очистить плитки</button>
                        <button class="tcalc-btn tcalc-btn-secondary" onclick="clearCanvas()">Очистить всё</button>
                    </div>
                </div>

                <div class="tcalc-section">
                    <h3>Инструкция</h3>
                    <div class="tcalc-instructions">
                        <ol>
                            <li>Выберите инструмент "Прямоугольник" или "Полигон"</li>
                            <li>Нарисуйте участок на холсте</li>
                            <li>Введите точные размеры участка в метрах</li>
                            <li>Нажмите "Заполнить участок плиткой" для автоматического заполнения всеми размерами</li>
                        </ol>
                    </div>
                </div>
            </div>

            <div class="tcalc-main">
                <div class="tcalc-canvas-container">
                    <canvas id="tcalc-canvas"></canvas>
                    <div class="tcalc-zoom-controls">
                        <button class="tcalc-zoom-btn" onclick="zoomIn()" title="Приблизить">+</button>
                        <span class="tcalc-zoom-level" id="tcalc-zoom-level" onclick="enableZoomInput()" title="Кликните для ввода масштаба">100%</span>
                        <button class="tcalc-zoom-btn" onclick="zoomOut()" title="Отдалить">−</button>
                        <button class="tcalc-zoom-btn" onclick="resetZoom()" title="Сбросить масштаб">⟲</button>
                    </div>
                </div>
                <div class="tcalc-status" id="tcalc-status">
                    Нарисуйте площадку для заполнения плиткой
                </div>
                <div class="tcalc-progress" id="tcalc-progress" style="display: none;">
                    <div class="tcalc-progress-fill" id="tcalc-progress-fill"></div>
                    <div class="tcalc-progress-text" id="tcalc-progress-text">Заполнение...</div>
                </div>
            </div>
        </div>

        <div id="tcalc-size-menu" style="display: none;">
            <div class="tcalc-size-menu-header">
                <div class="tcalc-size-menu-title">Размеры участка</div>
                <button class="tcalc-size-menu-close" onclick="hideSizeMenu()">&times;</button>
            </div>
            <div class="tcalc-size-inputs">
                <div class="tcalc-input-group">
                    <label for="tcalc-length-input">Длина (м)</label>
                    <input type="number" id="tcalc-length-input" step="0.01" min="0">
                </div>
                <div class="tcalc-input-group">
                    <label for="tcalc-width-input">Ширина (м)</label>
                    <input type="number" id="tcalc-width-input" step="0.01" min="0">
                </div>
                <div class="tcalc-input-group">
                    <label for="tcalc-area-input">Площадь (м²)</label>
                    <input type="number" id="tcalc-area-input" step="0.01" min="0" readonly>
                </div>
            </div>
            <div class="tcalc-size-actions">
                <button class="tcalc-size-btn tcalc-size-btn-primary" onclick="applySizeToBoundary()">Применить</button>
                <button class="tcalc-size-btn" onclick="deleteCurrentBoundary()">Удалить</button>
            </div>
        </div>
    </div>

    <script>
        // Конфигурация плитки
        const TILE_CONFIG = {
            'large': { width: 3.3, height: 2.2, name: 'Большая', price: 250 },
            'medium': { width: 2.2, height: 2.2, name: 'Средняя', price: 180 },
            'small': { width: 1.1, height: 2.2, name: 'Малая', price: 120 }
        };

        // Глобальные переменные
        let canvas;
        let currentTool = 'ruler';
        let isDrawing = false;
        let startPoint = null;
        let currentRect = null;
        let currentEditingBoundary = null;
        let tileCounts = { 'large': 0, 'medium': 0, 'small': 0 };
        let currentZoom = 1;
        let grid = {}; // Для оптимизации размещения плитки

        // Инициализация приложения
        document.addEventListener('DOMContentLoaded', function() {
            initCanvas();
            setupEventListeners();
        });

        // Инициализация холста
        function initCanvas() {
            canvas = new fabric.Canvas('tcalc-canvas', {
                backgroundColor: '#f8f9fa',
                selection: false,
                preserveObjectStacking: true
            });

            const container = document.querySelector('.tcalc-canvas-container');
            canvas.setWidth(container.offsetWidth);
            canvas.setHeight(600);

            // Добавляем сетку
            drawGrid();

            // Обработчики событий холста
            canvas.on('mouse:down', onMouseDown);
            canvas.on('mouse:move', onMouseMove);
            canvas.on('mouse:up', onMouseUp);
            canvas.on('object:modified', onObjectModified);
            canvas.on('object:rotating', onObjectRotating);
            canvas.on('selection:created', onSelectionCreated);
            canvas.on('selection:updated', onSelectionCreated);
            canvas.on('selection:cleared', onSelectionCleared);

            // Обработчики клавиатуры
            document.addEventListener('keydown', onKeyDown);
        }

        // Отрисовка сетки
        function drawGrid() {
            const gridSpacing = 10; // 10px = 1м
            const width = canvas.getWidth();
            const height = canvas.getHeight();

            for (let i = 0; i <= width; i += gridSpacing) {
                canvas.add(new fabric.Line([i, 0, i, height], {
                    stroke: '#e0e0e0',
                    selectable: false,
                    evented: false
                }));
            }

            for (let i = 0; i <= height; i += gridSpacing) {
                canvas.add(new fabric.Line([0, i, width, i], {
                    stroke: '#e0e0e0',
                    selectable: false,
                    evented: false
                }));
            }
        }

        // Обработчики событий мыши
        function onMouseDown(e) {
            if (e.e.button === 2) return; // Правая кнопка мыши

            const pointer = canvas.getPointer(e.e);

            if (currentTool === 'ruler') {
                isDrawing = true;
                startPoint = pointer;
                currentRect = new fabric.Rect({
                    left: startPoint.x,
                    top: startPoint.y,
                    width: 0,
                    height: 0,
                    fill: 'rgba(9, 132, 227, 0.1)',
                    stroke: '#0984e3',
                    strokeWidth: 1,
                    selectable: false,
                    data: { type: 'boundary' }
                });
                canvas.add(currentRect);
            } else if (currentTool === 'eraser') {
                if (e.target) {
                    if (confirm('Удалить этот объект?')) {
                        canvas.remove(e.target);
                        updateResults();
                        updateStatistics();
                    }
                }
            }
        }

        function onMouseMove(e) {
            if (!isDrawing) return;

            const pointer = canvas.getPointer(e.e);
            const width = Math.abs(pointer.x - startPoint.x);
            const height = Math.abs(pointer.y - startPoint.y);
            const left = Math.min(pointer.x, startPoint.x);
            const top = Math.min(pointer.y, startPoint.y);

            currentRect.set({ left: left, top: top, width: width, height: height });
            canvas.renderAll();
        }

        function onMouseUp(e) {
            if (isDrawing) {
                isDrawing = false;
                
                // Проверяем минимальный размер
                if (currentRect.width < 10 || currentRect.height < 10) {
                    canvas.remove(currentRect);
                    return;
                }

                // Делаем объект выделяемым
                currentRect.set({
                    selectable: true,
                    evented: true
                });

                // Сохраняем ссылку на редактируемый участок
                currentEditingBoundary = currentRect;

                // Показываем меню размеров
                showSizeMenu(currentRect);

                canvas.renderAll();

                // Показываем подсказку
                const status = document.getElementById('tcalc-status');
                status.textContent = 'Участок создан. Введите точные размеры.';
            }
        }

        // Работа с меню размеров
        function showSizeMenu(boundary) {
            if (!boundary) return;

            const menu = document.getElementById('tcalc-size-menu');
            const lengthInput = document.getElementById('tcalc-length-input');
            const widthInput = document.getElementById('tcalc-width-input');
            const areaInput = document.getElementById('tcalc-area-input');

            // Вычисляем размеры в метрах (1px = 0.1м)
            const widthMeters = boundary.width / 10;
            const heightMeters = boundary.height / 10;

            lengthInput.value = heightMeters.toFixed(2);
            widthInput.value = widthMeters.toFixed(2);
            areaInput.value = (widthMeters * heightMeters).toFixed(2);

            // Позиционируем меню рядом с объектом
            const bounds = boundary.getBoundingRect();
            menu.style.left = (bounds.left + bounds.width + 10) + 'px';
            menu.style.top = bounds.top + 'px';
            menu.style.display = 'block';
        }

        function hideSizeMenu() {
            document.getElementById('tcalc-size-menu').style.display = 'none';
        }

        function applySizeToBoundary() {
            if (!currentEditingBoundary) return;

            const lengthInput = document.getElementById('tcalc-length-input');
            const widthInput = document.getElementById('tcalc-width-input');
            const areaInput = document.getElementById('tcalc-area-input');

            const lengthMeters = parseFloat(lengthInput.value);
            const widthMeters = parseFloat(widthInput.value);

            // Проверяем валидность
            if (isNaN(lengthMeters) || isNaN(widthMeters) || lengthMeters <= 0 || widthMeters <= 0) {
                alert('Пожалуйста, введите корректные размеры (больше 0)');
                return;
            }

            // Конвертируем метры в пиксели (1м = 10px)
            const lengthPixels = lengthMeters * 10;
            const widthPixels = widthMeters * 10;

            // Обновляем размеры участка
            currentEditingBoundary.set({
                width: widthPixels,
                height: lengthPixels,
                scaleX: 1,
                scaleY: 1
            });

            // Обновляем canvas
            canvas.renderAll();

            // Обновляем статистику
            updateStatistics();

            // Скрываем меню
            hideSizeMenu();

            // Показываем подтверждение
            const status = document.getElementById('tcalc-status');
            status.textContent = `Размеры площадки обновлены: ${widthMeters.toFixed(2)}м × ${lengthMeters.toFixed(2)}м`;
        }

        function deleteCurrentBoundary() {
            if (!currentEditingBoundary) return;

            if (confirm('Вы уверены, что хотите удалить эту площадку?')) {
                // Удаляем все плитки внутри участка
                const tiles = canvas.getObjects().filter(obj => 
                    obj.data && obj.data.type === 'tile'
                );
                
                tiles.forEach(tile => canvas.remove(tile));

                // Удаляем сам участок
                canvas.remove(currentEditingBoundary);

                // Скрываем меню
                hideSizeMenu();

                // Очищаем ссылку на редактируемый участок
                currentEditingBoundary = null;

                // Обновляем результаты
                canvas.renderAll();
                updateResults();
                updateStatistics();
            }
        }

        // Обработчики событий объектов
        function onObjectModified(e) {
            if (e.target && e.target.data && e.target.data.type === 'tile') {
                updateResults();
                updateStatistics();
            }

            // Обновляем меню размеров при изменении площадки
            if (e.target && e.target.data && e.target.data.type === 'boundary') {
                currentEditingBoundary = e.target;
                updateSizeMenu(e.target);
            }
        }

        function onObjectRotating(e) {
            if (e.target && e.target.data && e.target.data.type === 'boundary') {
                // Обновляем индикатор угла поворота
                updateRotationIndicator(e.target);
            }
        }

        function onSelectionCreated(e) {
            if (e.target && e.target.data && e.target.data.type === 'boundary') {
                currentEditingBoundary = e.target;
                showSizeMenu(e.target);
            }
        }

        function onSelectionCleared(e) {
            hideSizeMenu();
        }

        // Обработчики клавиатуры
        function onKeyDown(e) {
            // Обработка Escape для скрытия меню и выбора
            if (e.key === 'Escape') {
                canvas.discardActiveObject();
                hideSizeMenu();
                canvas.renderAll();
            }
        }

        // Обновление меню размеров
        function updateSizeMenu(boundary) {
            if (!boundary) return;

            const lengthInput = document.getElementById('tcalc-length-input');
            const widthInput = document.getElementById('tcalc-width-input');
            const areaInput = document.getElementById('tcalc-area-input');

            // Вычисляем размеры в метрах (1px = 0.1м)
            const widthMeters = boundary.width / 10;
            const heightMeters = boundary.height / 10;

            lengthInput.value = heightMeters.toFixed(2);
            widthInput.value = widthMeters.toFixed(2);
            areaInput.value = (widthMeters * heightMeters).toFixed(2);
        }

        // Выбор инструмента
        function selectTool(tool) {
            currentTool = tool;
            document.querySelectorAll('.tcalc-tool-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-tool="${tool}"]`).classList.add('active');

            const status = document.getElementById('tcalc-status');
            if (tool === 'ruler') {
                status.textContent = 'Нарисуйте площадку для заполнения плиткой';
            } else if (tool === 'eraser') {
                status.textContent = 'Кликните на объект для удаления';
            } else if (tool === 'polygon') {
                status.textContent = 'Нарисуйте полигон для рисования';
            }

            if (tool === 'ruler') {
                canvas.defaultCursor = 'crosshair';
            } else if (tool === 'eraser') {
                canvas.defaultCursor = 'pointer';
                canvas.selection = false;
            } else if (tool === 'polygon') {
                canvas.defaultCursor = 'crosshair';
                canvas.selection = false;
            } else {
                canvas.defaultCursor = 'default';
                canvas.selection = true;
            }
        }

        // Загрузка плана
        function loadPlan(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                fabric.Image.fromURL(e.target.result, function(img) {
                    // Масштабируем изображение под размер canvas
                    const canvasWidth = canvas.getWidth();
                    const canvasHeight = canvas.getHeight();
                    const scaleX = canvasWidth / img.width;
                    const scaleY = canvasHeight / img.height;
                    const scale = Math.min(scaleX, scaleY);

                    img.scale(scale);
                    img.set({
                        left: (canvasWidth - img.width * scale) / 2,
                        top: (canvasHeight - img.height * scale) / 2,
                        selectable: false,
                        evented: false
                    });

                    canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas));
                });
            };
            reader.readAsDataURL(file);
        }

        // Очистка плиток
        function clearTiles() {
            if (confirm('Очистить все плитки?')) {
                const tiles = canvas.getObjects().filter(obj => 
                    obj.data && obj.data.type === 'tile'
                );
                
                tiles.forEach(tile => canvas.remove(tile));
                canvas.renderAll();
                updateResults();
                updateStatistics();
            }
        }

        // Очистка всего холста
        function clearCanvas() {
            if (confirm('Очистить весь холст?')) {
                canvas.clear();
                canvas.setBackgroundImage(null, canvas.renderAll.bind(canvas));
                drawGrid();
                updateResults();
                updateStatistics();
            }
        }

        // Обновление результатов
        function updateResults() {
            // Сбрасываем счетчики
            tileCounts = { 'large': 0, 'medium': 0, 'small': 0 };

            // Подсчитываем плитки
            canvas.getObjects().forEach(obj => {
                if (obj.data && obj.data.type === 'tile' && obj.data.tileType) {
                    tileCounts[obj.data.tileType]++;
                }
            });

            // Обновляем UI
            document.getElementById('tcalc-count-large').textContent = tileCounts['large'];
            document.getElementById('tcalc-count-medium').textContent = tileCounts['medium'];
            document.getElementById('tcalc-count-small').textContent = tileCounts['small'];
            document.getElementById('tcalc-total-count').textContent = 
                (tileCounts['large'] + tileCounts['medium'] + tileCounts['small']);
        }

        // Обновление статистики
        function updateStatistics() {
            // Вычисляем площадь участка
            const boundaries = canvas.getObjects().filter(obj => 
                obj.data && obj.data.type === 'boundary'
            );

            let totalArea = 0;
            let totalPerimeter = 0;
            let totalCost = 0;

            boundaries.forEach(boundary => {
                if (boundary.type === 'rect') {
                    // Используем текущие размеры с учетом масштабирования
                    const currentWidth = boundary.width * (boundary.scaleX || 1);
                    const currentHeight = boundary.height * (boundary.scaleY || 1);

                    // в м² (1px = 100мм = 0.1м)
                    const area = (currentWidth * currentHeight) / 100;
                    const perimeter = 2 * (currentWidth + currentHeight) / 10; // в м

                    totalArea += area;
                    totalPerimeter += perimeter;
                }
            });

            // Вычисляем стоимость
            totalCost = 
                tileCounts['large'] * TILE_CONFIG['large'].price +
                tileCounts['medium'] * TILE_CONFIG['medium'].price +
                tileCounts['small'] * TILE_CONFIG['small'].price;

            // Вычисляем покрытие (примерное)
            const coverage = totalArea > 0 ? Math.min(100, (tileCounts['large'] * 3.3 * 2.2 + 
                tileCounts['medium'] * 2.2 * 2.2 + 
                tileCounts['small'] * 1.1 * 2.2) / totalArea * 100) : 0;

            // Обновляем UI
            document.getElementById('tcalc-area').textContent = totalArea.toFixed(2) + ' м²';
            document.getElementById('tcalc-perimeter').textContent = totalPerimeter.toFixed(2) + ' м';
            document.getElementById('tcalc-coverage').textContent = coverage.toFixed(1) + '%';
            document.getElementById('tcalc-cost').textContent = totalCost.toLocaleString() + ' руб.';
        }

        // Заполнение участка плиткой (оптимизированная версия)
        function fillAreaWithTiles() {
            // Находим границы участка
            const boundaries = canvas.getObjects().filter(obj => 
                obj.data && obj.data.type === 'boundary'
            );

            if (boundaries.length === 0) {
                alert('Сначала нарисуйте площадку!');
                return;
            }

            // Показываем индикатор загрузки
            const btn = document.querySelector('[onclick="fillAreaWithTiles()"]');
            const originalText = btn.textContent;
            btn.textContent = 'Заполнение...';
            btn.disabled = true;

            // Очищаем существующие плитки
            const tiles = canvas.getObjects().filter(obj => 
                obj.data && obj.data.type === 'tile'
            );
            
            tiles.forEach(tile => canvas.remove(tile));

            // Сбрасываем сетку
            grid = {};

            // Запускаем постепенное заполнение
            fillBoundariesGradually(boundaries, 0, btn, originalText);
        }

        function fillBoundariesGradually(boundaries, index, btn, originalText) {
            if (index >= boundaries.length) {
                // Все участки заполнены
                canvas.renderAll();
                updateResults();
                updateStatistics();
                btn.textContent = originalText;
                btn.disabled = false;
                return;
            }

            const boundary = boundaries[index];
            fillBoundaryGradually(boundary, 0, () => {
                // Переходим к следующему участку
                setTimeout(() => {
                    fillBoundariesGradually(boundaries, index + 1, btn, originalText);
                }, 50);
            });
        }

        function fillBoundaryGradually(boundary, tileCount, callback) {
            // Получаем текущие границы области
            const bounds = {
                left: boundary.left,
                top: boundary.top,
                right: boundary.left + boundary.width,
                bottom: boundary.top + boundary.height
            };

            // Проверяем размеры области
            const areaWidth = bounds.right - bounds.left;
            const areaHeight = bounds.bottom - bounds.top;

            if (areaWidth < 10 || areaHeight < 10) {
                callback();
                return;
            }

            // Оптимизированное заполнение плиткой
            const tileTypes = ['large', 'medium', 'small'];
            let placedTiles = 0;
            let attempts = 0;
            const maxAttempts = 1000;

            // Функция для проверки свободного места
            function isSpaceFree(x, y, width, height) {
                // Проверяем выход за границы
                if (x < bounds.left || y < bounds.top || 
                    x + width > bounds.right || y + height > bounds.bottom) {
                    return false;
                }

                // Проверяем пересечение с существующими плитками
                for (let i = Math.floor(x); i < Math.ceil(x + width); i++) {
                    for (let j = Math.floor(y); j < Math.ceil(y + height); j++) {
                        if (grid[`${i},${j}`]) return false;
                    }
                }

                return true;
            }

            // Функция для отметки места как занятого
            function markSpaceOccupied(x, y, width, height) {
                for (let i = Math.floor(x); i < Math.ceil(x + width); i++) {
                    for (let j = Math.floor(y); j < Math.ceil(y + height); j++) {
                        grid[`${i},${j}`] = true;
                    }
                }
            }

            // Функция для поиска места для плитки
            function findPosition(width, height) {
                for (let y = bounds.top; y <= bounds.bottom - height; y += 0.5) {
                    for (let x = bounds.left; x <= bounds.right - width; x += 0.5) {
                        if (isSpaceFree(x, y, width, height)) {
                            return { x, y };
                        }
                    }
                }
                return null;
            }

            // Размещаем несколько плиток за раз (для ускорения)
            const tilesPerBatch = 10;
            let batchPlaced = 0;

            while (batchPlaced < tilesPerBatch && attempts < maxAttempts) {
                attempts++;

                // Выбираем размер плитки с приоритетом на большие
                let tileType;
                if (tileCount % 5 === 0) {
                    tileType = 'large';
                } else if (tileCount % 3 === 0) {
                    tileType = 'medium';
                } else {
                    tileType = 'small';
                }

                const config = TILE_CONFIG[tileType];

                // Ищем место для плитки
                let position = findPosition(config.width, config.height);
                if (position) {
                    // Создаем плитку
                    const gradient = new fabric.Gradient({
                        type: 'linear',
                        coords: { x1: 0, y1: 0, x2: config.width, y2: config.height },
                        colorStops: [
                            { offset: 0, color: '#ffffff' },
                            { offset: 1, color: '#cccccc' }
                        ]
                    });

                    const tile = new fabric.Rect({
                        left: position.x,
                        top: position.y,
                        width: config.width,
                        height: config.height,
                        fill: gradient,
                        stroke: '#d2b48c',
                        strokeWidth: 0.05,
                        selectable: false,
                        data: { type: 'tile', tileType: tileType }
                    });

                    canvas.add(tile);
                    markSpaceOccupied(position.x, position.y, config.width, config.height);
                    placedTiles++;
                    batchPlaced++;
                    tileCount++;
                } else {
                    // Если не нашли место для этого размера, пробуем следующий
                    break;
                }
            }

            // Обновляем canvas и статистику
            canvas.renderAll();
            updateResults();

            // Проверяем, нужно ли продолжить
            if (placedTiles > 0 && tileCount < 10000) {
                // Продолжаем заполнение
                setTimeout(() => {
                    fillBoundaryGradually(boundary, tileCount, callback);
                }, 1);
            } else {
                callback();
            }
        }

        // Функции масштабирования
        function zoomIn() {
            if (currentZoom < 3) {
                currentZoom += 0.1;
                applyZoom();
            }
        }

        function zoomOut() {
            if (currentZoom > 0.5) {
                currentZoom -= 0.1;
                applyZoom();
            }
        }

        function resetZoom() {
            currentZoom = 1;
            applyZoom();
        }

        function applyZoom() {
            canvas.setZoom(currentZoom);
            document.getElementById('tcalc-zoom-level').textContent = Math.round(currentZoom * 100) + '%';
        }

        function enableZoomInput() {
            const zoomLevelElement = document.getElementById('tcalc-zoom-level');
            if (!zoomLevelElement) return;

            const currentZoomPercent = Math.round(currentZoom * 100);
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentZoomPercent;
            input.className = 'tcalc-zoom-input';
            input.style.width = '50px';
            input.style.padding = '2px 5px';
            input.style.border = '1px solid #ddd';
            input.style.borderRadius = '3px';
            input.style.textAlign = 'center';

            input.addEventListener('blur', () => cancelZoomInput(input));
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    const value = parseInt(input.value);
                    if (!isNaN(value) && value >= 50 && value <= 300) {
                        currentZoom = value / 100;
                        applyZoom();
                        restoreZoomSpan(input, value + '%');
                    } else {
                        cancelZoomInput(input);
                    }
                } else if (e.key === 'Escape') {
                    cancelZoomInput(input);
                }
            });

            zoomLevelElement.parentNode.replaceChild(input, zoomLevelElement);
            input.focus();
            input.select();
        }

        function cancelZoomInput(input) {
            restoreZoomSpan(input, Math.round(currentZoom * 100) + '%');
        }

        function restoreZoomSpan(input, text) {
            const span = document.createElement('span');
            span.className = 'tcalc-zoom-level';
            span.id = 'tcalc-zoom-level';
            span.textContent = text;
            span.onclick = enableZoomInput;
            span.title = 'Кликните для ввода масштаба (50-300%)';

            input.parentNode.replaceChild(span, input);
        }

        // Обновление индикатора угла поворота
        function updateRotationIndicator(boundary) {
            // Пока не реализовано
        }

        // Настройка обработчиков событий
        function setupEventListeners() {
            // Обработчик клика вне меню для его скрытия
            document.addEventListener('click', function(e) {
                // Игнорируем правую кнопку мыши
                if (e.button === 2) return;

                const menu = document.getElementById('tcalc-size-menu');
                if (menu && menu.style.display !== 'none') {
                    // Проверяем, кликнули ли мы вне меню
                    if (!menu.contains(e.target) && 
                        !(currentEditingBoundary && 
                          canvas.getActiveObject() === currentEditingBoundary)) {
                        hideSizeMenu();
                    }
                }
            });
        }
    </script>
</body>
</html>
```
